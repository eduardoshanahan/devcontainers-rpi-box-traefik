---
- name: Initialize Traefik env validation list
  ansible.builtin.set_fact:
    traefik_missing_env: []

- name: Check required Traefik environment variables
  ansible.builtin.set_fact:
    traefik_missing_env: "{{ traefik_missing_env + [item] }}"
  when: lookup('env', item) | length == 0
  loop: "{{ traefik_required_env_vars }}"

- name: Fail when required Traefik environment variables are missing
  ansible.builtin.assert:
    that:
      - traefik_missing_env | length == 0
    fail_msg: >-
      Missing required environment variables: {{ traefik_missing_env | join(', ') }}

- name: Validate Traefik certificate paths
  ansible.builtin.assert:
    that:
      - (traefik_cert_file | dirname) == traefik_cert_dir
      - (traefik_key_file | dirname) == traefik_cert_dir
    fail_msg: >-
      TRAEFIK_CERT_FILE and TRAEFIK_KEY_FILE must live under TRAEFIK_CERT_DIR.

- name: Validate Traefik systemd autostart value
  ansible.builtin.assert:
    that:
      - traefik_systemd_autostart | lower in ["true", "false"]
    fail_msg: >-
      TRAEFIK_SYSTEMD_AUTOSTART must be "true" or "false".

- name: Set Traefik systemd autostart boolean
  ansible.builtin.set_fact:
    traefik_systemd_autostart_enabled: "{{ traefik_systemd_autostart | lower == 'true' }}"

- name: Ensure Traefik directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - "{{ traefik_stack_dir }}"
    - "{{ traefik_config_dir }}"
    - "{{ traefik_data_dir }}"
    - "{{ traefik_cert_dir }}"

- name: Ensure Traefik certificate files exist
  ansible.builtin.stat:
    path: "{{ item }}"
  register: traefik_cert_stats
  loop:
    - "{{ traefik_cert_file }}"
    - "{{ traefik_key_file }}"

- name: Fail if Traefik certificate files are missing
  ansible.builtin.assert:
    that:
      - traefik_cert_stats.results | map(attribute='stat.exists') | min
    fail_msg: >-
      Traefik certificate or key file is missing. Expected files:
      {{ traefik_cert_file }}, {{ traefik_key_file }}

- name: Create shared Docker network for Traefik
  community.docker.docker_network:
    name: "{{ traefik_docker_network }}"
    state: present

- name: Render Traefik static configuration
  ansible.builtin.template:
    src: traefik.yml.j2
    dest: "{{ traefik_config_dir }}/traefik.yml"
    owner: root
    group: root
    mode: "0644"

- name: Render Traefik dynamic configuration
  ansible.builtin.template:
    src: dynamic.yml.j2
    dest: "{{ traefik_config_dir }}/dynamic.yml"
    owner: root
    group: root
    mode: "0644"

- name: Render Traefik docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ traefik_stack_dir }}/docker-compose.yml"
    owner: root
    group: root
    mode: "0644"

- name: Deploy Traefik with Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ traefik_stack_dir }}"
    state: present

- name: Install Traefik systemd unit
  ansible.builtin.template:
    src: traefik.service.j2
    dest: /etc/systemd/system/traefik.service
    owner: root
    group: root
    mode: "0644"
  when: traefik_systemd_autostart_enabled

- name: Enable Traefik systemd unit
  ansible.builtin.systemd:
    name: traefik
    enabled: true
    daemon_reload: true
  when: traefik_systemd_autostart_enabled
