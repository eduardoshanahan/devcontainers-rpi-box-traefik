---
- name: Initialize Traefik env validation list
  ansible.builtin.set_fact:
    traefik_missing_env: []
    traefik_cert_regenerated: false
    traefik_cert_regen_reason: "none"

- name: Check required Traefik environment variables
  ansible.builtin.set_fact:
    traefik_missing_env: "{{ traefik_missing_env + [item] }}"
  when: lookup('env', item) | length == 0
  loop: "{{ traefik_required_env_vars }}"

- name: Fail when required Traefik environment variables are missing
  ansible.builtin.assert:
    that:
      - traefik_missing_env | length == 0
    fail_msg: >-
      Missing required environment variables: {{ traefik_missing_env | join(', ') }}

- name: Validate Traefik enabled value
  ansible.builtin.assert:
    that:
      - traefik_enabled | lower in ["true", "false"]
    fail_msg: >-
      TRAEFIK_ENABLED must be "true" or "false".

- name: Set Traefik enabled boolean
  ansible.builtin.set_fact:
    traefik_enabled_bool: "{{ traefik_enabled | lower == 'true' }}"

- name: Check required Traefik environment variables when enabled
  ansible.builtin.set_fact:
    traefik_missing_env: "{{ traefik_missing_env + [item] }}"
  when: traefik_enabled_bool and lookup('env', item) | length == 0
  loop: "{{ traefik_required_env_vars_when_enabled }}"

- name: Fail when required Traefik environment variables are missing (enabled)
  ansible.builtin.assert:
    that:
      - traefik_missing_env | length == 0
    fail_msg: >-
      Missing required environment variables: {{ traefik_missing_env | join(', ') }}
  when: traefik_enabled_bool

- name: Deploy Traefik when enabled
  ansible.builtin.include_tasks: deploy.yml
  when: traefik_enabled_bool

- name: Skip Traefik deployment when disabled
  ansible.builtin.debug:
    msg: "TRAEFIK_ENABLED=false; skipping Traefik deployment for {{ inventory_hostname }}."
  when: not traefik_enabled_bool
