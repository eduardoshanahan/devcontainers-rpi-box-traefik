---
traefik_required_env_vars:
  - TRAEFIK_ENABLED

traefik_enabled: "{{ lookup('env', 'TRAEFIK_ENABLED') }}"

# When disabled, skip the Traefik role without requiring the rest of the Traefik env vars.
traefik_required_env_vars_when_enabled:
  - TRAEFIK_IMAGE
  - TRAEFIK_CONTAINER_NAME
  - TRAEFIK_HTTP_PORT
  - TRAEFIK_HTTPS_PORT
  - TRAEFIK_WEB_PORT
  - TRAEFIK_DOCKER_NETWORK
  - TRAEFIK_STACK_DIR
  - TRAEFIK_CONFIG_DIR
  - TRAEFIK_DATA_DIR
  - TRAEFIK_CERT_DIR
  - TRAEFIK_CERT_FILE
  - TRAEFIK_KEY_FILE
  - TRAEFIK_SYSTEMD_AUTOSTART
  - TRAEFIK_LOG_LEVEL
  - CA_SHARE_ENABLED
  - TRAEFIK_FORCE_REGEN_CERT

traefik_image: "{{ lookup('env', 'TRAEFIK_IMAGE') }}"
traefik_container_name: "{{ lookup('env', 'TRAEFIK_CONTAINER_NAME') }}"
traefik_http_port: "{{ lookup('env', 'TRAEFIK_HTTP_PORT') }}"
traefik_https_port: "{{ lookup('env', 'TRAEFIK_HTTPS_PORT') }}"
traefik_web_port: "{{ lookup('env', 'TRAEFIK_WEB_PORT') }}"
traefik_docker_network: "{{ lookup('env', 'TRAEFIK_DOCKER_NETWORK') }}"
traefik_stack_dir: "{{ lookup('env', 'TRAEFIK_STACK_DIR') }}"
traefik_config_dir: "{{ lookup('env', 'TRAEFIK_CONFIG_DIR') }}"
traefik_data_dir: "{{ lookup('env', 'TRAEFIK_DATA_DIR') }}"
traefik_cert_dir: "{{ lookup('env', 'TRAEFIK_CERT_DIR') }}"
traefik_cert_file: "{{ lookup('env', 'TRAEFIK_CERT_FILE') }}"
traefik_key_file: "{{ lookup('env', 'TRAEFIK_KEY_FILE') }}"
traefik_systemd_autostart: "{{ lookup('env', 'TRAEFIK_SYSTEMD_AUTOSTART') }}"
traefik_log_level: "{{ lookup('env', 'TRAEFIK_LOG_LEVEL') }}"
traefik_docker_api_version: "{{ lookup('env', 'TRAEFIK_DOCKER_API_VERSION') | default('', true) }}"
traefik_docker_host: "{{ lookup('env', 'TRAEFIK_DOCKER_HOST') | default('unix:///var/run/docker.sock', true) }}"

traefik_dashboard_enabled: >-
  {{ (lookup('env', 'TRAEFIK_DASHBOARD_ENABLED') | default('false', true)) | lower == 'true' }}

traefik_dashboard_basic_auth_enabled: >-
  {{ (lookup('env', 'TRAEFIK_DASHBOARD_BASIC_AUTH_ENABLED') | default('false', true)) | lower == 'true' }}
traefik_dashboard_basic_auth_users: >-
  {{
    lookup('env', 'TRAEFIK_DASHBOARD_BASIC_AUTH_USERS')
    | default('', true)
    | trim
    | trim('"')
  }}

traefik_dashboard_ip_allowlist_enabled: >-
  {{ (lookup('env', 'TRAEFIK_DASHBOARD_IP_ALLOWLIST_ENABLED') | default('false', true)) | lower == 'true' }}
traefik_dashboard_ip_allowlist: >-
  {{
    lookup('env', 'TRAEFIK_DASHBOARD_IP_ALLOWLIST')
    | default('', true)
    | trim
    | trim('"')
  }}

traefik_admin_security_headers_enabled: >-
  {{ (lookup('env', 'TRAEFIK_ADMIN_SECURITY_HEADERS_ENABLED') | default('true', true)) | lower == 'true' }}
traefik_admin_basic_auth_enabled: >-
  {{ (lookup('env', 'TRAEFIK_ADMIN_BASIC_AUTH_ENABLED') | default('false', true)) | lower == 'true' }}
traefik_admin_basic_auth_users: >-
  {{
    lookup('env', 'TRAEFIK_ADMIN_BASIC_AUTH_USERS')
    | default('', true)
    | trim
    | trim('"')
  }}
traefik_admin_ip_allowlist_enabled: >-
  {{ (lookup('env', 'TRAEFIK_ADMIN_IP_ALLOWLIST_ENABLED') | default('false', true)) | lower == 'true' }}
traefik_admin_ip_allowlist: >-
  {{
    lookup('env', 'TRAEFIK_ADMIN_IP_ALLOWLIST')
    | default('', true)
    | trim
    | trim('"')
  }}

traefik_dashboard_basic_auth_enabled_effective: >-
  {{ traefik_dashboard_basic_auth_enabled or traefik_admin_basic_auth_enabled }}
traefik_dashboard_basic_auth_users_effective: >-
  {{
    traefik_dashboard_basic_auth_users
    if (traefik_dashboard_basic_auth_users | trim | length > 0)
    else traefik_admin_basic_auth_users
  }}
traefik_dashboard_ip_allowlist_enabled_effective: >-
  {{ traefik_dashboard_ip_allowlist_enabled or traefik_admin_ip_allowlist_enabled }}
traefik_dashboard_ip_allowlist_effective: >-
  {{
    traefik_dashboard_ip_allowlist
    if (traefik_dashboard_ip_allowlist | trim | length > 0)
    else traefik_admin_ip_allowlist
  }}

traefik_workspace_folder: "{{ lookup('env', 'WORKSPACE_FOLDER') | default('/workspace', true) }}"
traefik_local_cert_dir_raw: >-
  {{ lookup('env', 'TRAEFIK_LOCAL_CERT_DIR') | default(traefik_workspace_folder ~ '/certs', true) }}
traefik_local_cert_dir_expanded: >-
  {{
    traefik_local_cert_dir_raw
    | replace('${WORKSPACE_FOLDER}', traefik_workspace_folder)
    | replace('$WORKSPACE_FOLDER', traefik_workspace_folder)
    | trim
  }}
traefik_local_cert_dir: >-
  {{
    traefik_local_cert_dir_expanded
    if (traefik_local_cert_dir_expanded is match('^/'))
    else (traefik_workspace_folder ~ '/' ~ traefik_local_cert_dir_expanded)
  }}
traefik_site_domain: "{{ lookup('env', 'SITE_DOMAIN') | trim | lower }}"
traefik_box_name: "{{ (box_name | default(inventory_hostname)) | trim | lower }}"

traefik_local_cert_file: "{{ traefik_local_cert_dir }}/{{ traefik_box_name }}.{{ traefik_site_domain }}.crt"
traefik_local_key_file: "{{ traefik_local_cert_dir }}/{{ traefik_box_name }}.{{ traefik_site_domain }}.key"
traefik_local_ca_export_file: "{{ traefik_local_cert_dir }}/rootCA.pem"
traefik_cert_hosts: []

traefik_ca_verify_enabled: "{{ lookup('env', 'CA_SHARE_ENABLED') | lower == 'true' }}"
traefik_force_regen_cert: "{{ lookup('env', 'TRAEFIK_FORCE_REGEN_CERT') | lower == 'true' }}"
