---
- name: Initialize whoami env validation list
  ansible.builtin.set_fact:
    whoami_missing_env: []

- name: Check required whoami environment variables
  ansible.builtin.set_fact:
    whoami_missing_env: "{{ whoami_missing_env + [item] }}"
  when: lookup('env', item) | length == 0
  loop: "{{ whoami_required_env_vars }}"

- name: Fail when required whoami environment variables are missing
  ansible.builtin.assert:
    that:
      - whoami_missing_env | length == 0
    fail_msg: >-
      Missing required environment variables: {{ whoami_missing_env | join(', ') }}

- name: Fail when whoami host is not defined
  ansible.builtin.assert:
    that:
      - whoami_host is defined
      - whoami_host | length > 0
    fail_msg: >-
      whoami_host must be set per host (e.g. in host_vars).

- name: Fail when whoami host lacks a domain suffix
  ansible.builtin.assert:
    that:
      - (whoami_host | trim) is search('\\.')
      - ((whoami_host | trim).split('.', 1)[1] | length) > 0
    fail_msg: >-
      whoami_host must include a domain suffix (example: whoami.example.test).

- name: Build allowed certificate suffixes for whoami host
  ansible.builtin.set_fact:
    whoami_cert_suffixes: >-
      {{ traefik_cert_hosts
         | map('trim')
         | map('regex_replace', '^[*][.]', '')
         | map('lower')
         | list }}
    whoami_host_suffix: >-
      {{ (whoami_host | lower | trim).split('.', 1)[1] }}

- name: Ensure whoami host matches Traefik certificate SANs
  ansible.builtin.assert:
    that:
      - whoami_cert_suffixes | length > 0
      - whoami_host_suffix in whoami_cert_suffixes
    fail_msg: >-
      whoami_host ({{ whoami_host }}) does not match any Traefik certificate SANs:
      {{ whoami_cert_suffixes | join(', ') }}

- name: Ensure whoami stack directory exists
  ansible.builtin.file:
    path: "{{ whoami_stack_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure shared Docker network exists
  community.docker.docker_network:
    name: "{{ whoami_docker_network }}"
    state: present

- name: Render whoami docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ whoami_stack_dir }}/docker-compose.yml"
    owner: root
    group: root
    mode: "0644"

- name: Deploy whoami with Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ whoami_stack_dir }}"
    state: present

- name: Pause before verifying whoami endpoint
  ansible.builtin.pause:
    seconds: "{{ whoami_verify_delay_seconds }}"
  when: whoami_verify_enabled

- name: Fail when WHOAMI_VERIFY_USE_TRAEFIK_API=true (hardening)
  ansible.builtin.fail:
    msg: >-
      WHOAMI_VERIFY_USE_TRAEFIK_API is no longer supported because Traefik hardening disables direct API/dashboard exposure by IP.
      Verify using the HTTPS request check (default), or enable the dashboard on a protected FQDN and inspect routers in the dashboard.
  when: whoami_verify_enabled and whoami_verify_use_traefik_api

- name: Verify whoami endpoint via Traefik
  ansible.builtin.uri:
    url: >-
      https://127.0.0.1:{{ lookup('env', 'TRAEFIK_HTTPS_PORT') | default('443', true) }}/
    method: GET
    return_content: true
    status_code: 200
    validate_certs: false
    headers:
      Host: "{{ whoami_host }}"
      User-Agent: "ansible-traefik-verify"
  register: whoami_verify_response
  retries: "{{ whoami_verify_retries }}"
  delay: "{{ whoami_verify_retry_delay }}"
  until: whoami_verify_response.status == 200
  failed_when: "'Hostname' not in (whoami_verify_response.content | default(''))"
  delegate_to: "{{ inventory_hostname }}"
  run_once: true
  when: whoami_verify_enabled
