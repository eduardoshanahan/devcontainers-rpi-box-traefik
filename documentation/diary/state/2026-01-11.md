# 2026-01-11

## Current Status

- ADRs document the intended revamp direction for naming and name resolution.
- Traefik usage is defined as opt-in per service (decision matrix ADR).
- `TRAEFIK_ENABLED=true|false` is available in `.env` to toggle Traefik deployment from this repo.
- ADR documents the plan to support multiple TLS strategies (mkcert for LAN, ACME for public VPS) via `TRAEFIK_TLS_MODE`.
- Name-resolution env vars are present in `.env.example` (`SITE_DOMAIN`, `NAME_RESOLUTION_MODE`, `DNS_PREFLIGHT_CHECK`, `HOSTS_SNIPPET_OUTPUT_FILE`).
- Service FQDNs are derived from `service.<box_name>.<SITE_DOMAIN>` (with optional per-host overrides and optional `box_name` for DNS-safe names).
- In `NAME_RESOLUTION_MODE=hosts`, `dns_preflight` prints a deterministic client `/etc/hosts` snippet and writes it to `HOSTS_SNIPPET_OUTPUT_FILE` (default: repo-local `hosts-snippet.txt`).
- In `NAME_RESOLUTION_MODE=dns`, `dns_preflight` fails fast if required names do not resolve (scope controlled by `DNS_PREFLIGHT_CHECK`).
- Traefik dashboard FQDN/router is now opt-in via `TRAEFIK_DASHBOARD_ENABLED=true|false`.
- Traefik hardening: removed `api.insecure: true`, bound `TRAEFIK_WEB_PORT` to localhost only, and required access control for the dashboard router (basic auth and/or IP allowlist).
- TLS certs (mkcert): SANs are derived per box (`*.box.SITE_DOMAIN` and `box.SITE_DOMAIN`) and local cert outputs are named per box to avoid collisions across multiple targets.
- Canonical “how-to” docs for apps and Pi-hole integration notes now live under `documentation/`.
- CA share UX: serves a landing page and the CA at a stable path (`https://ca.<box>.<domain>/rootCA.pem`).
- CA share gating: works with both `NAME_RESOLUTION_MODE=hosts` (requires /etc/hosts snippet readiness) and `NAME_RESOLUTION_MODE=dns` (fail-fast resolution checks).
- Shared Traefik middlewares: admin UIs get standard security headers, with optional shared basic auth and/or IP allowlist applied consistently.
- Playbook split: `src/playbooks/pi-edge.yml` deploys Traefik + CA share; `src/playbooks/pi-apps.yml` deploys app workloads; `src/playbooks/pi-full.yml` runs both in order.
- Removed `pihole_sync` from `src/` (role + playbook) and removed `PIHOLE_*` settings from `.env.example`; Pi-hole remains documentation-only (`documentation/pihole-traefik-instructions.md`).
- Devcontainer build is fail-fast on `LOCALE` and pinned Ansible toolchain versions; `git-filter-repo` is available in the image.
- Devcontainer shells source `.devcontainer/scripts/bash-prompt.sh` globally (interactive and login shells).
- Devcontainer VS Code extensions include `anthropic.claude-code`.
- Devcontainer forwards the host SSH agent socket at `/ssh-agent` (sets `SSH_AUTH_SOCK=/ssh-agent`).
- Devcontainer workspace path is configurable via `WORKSPACE_FOLDER` (defaults to `/workspace`).
- Starship prompt shows `PROJECT_NAME` (not user/host) and uses a compact first line.
- Bash prompt initialization is robust under `set -u` and uses the repo Starship config.
- `env-loader.sh` is fail-fast on missing `.env` and preserves forwarded `SSH_AUTH_SOCK`.
- `verify-git-ssh.sh` accepts `GIT_SSH_HOST` when no argument is provided.
- Host-side env validation checks `SSH_AUTH_SOCK` and additional required vars (`PROJECT_NAME`, `WORKSPACE_FOLDER`, `ANSIBLE_*` paths).
- `ssh-agent-setup.sh` reuses an existing local agent when available and avoids breaking interactive shells when sourced.
- `init-devcontainer.sh` uses `WORKSPACE_FOLDER` for repo-local Git identity configuration.
- `post-create.sh` validates env + ensures `.bashrc` guard for `VSCODE_SHELL_LOGIN`.
- Devcontainer can optionally install the Claude CLI at build time via `INSTALL_CLAUDE` (with `CLAUDE_INSTALL_SHA256` optional).
- Documentation hygiene: no emoji characters outside `src/` (repo-wide scan).
- Host/helper defaults are documented in `.env.example` (workspace, smoke tests, image cleanup), and launchers no longer silently fall back for required vars.
- Devcontainer scripts validate env early (and derive workspace path from script location) instead of relying on inline required-var expansions.
- Host-side env validation is centralized in `scripts/validate-env.sh`; devcontainer scripts assume launcher-started env and warn/fail with a clear hint otherwise.
- Devcontainer config uses only the project-root `.env` (removed `.devcontainer/config/.env*`).
- Env validation patterns accept current pins (`LOCALE=en_IE.UTF-8`, `ANSIBLE_CORE_VERSION=2.17.*`, etc.).
- Claude workflow expects the image to include `claude` (launcher forces `INSTALL_CLAUDE=true`).
- Starship prompt no longer shows the session container hostname.
- Image naming: `.env` uses `${PROJECT_NAME}-${EDITOR_CHOICE}` for editor workflows; `./devcontainer-launch.sh` forces `${PROJECT_NAME}-devcontainer`; `./claude-launch.sh` forces `${PROJECT_NAME}-claude` and `INSTALL_CLAUDE=true`.
- Standardized boolean flags to `true|false` (removed remaining `...=1` style toggles and docs, and scripts treat them as shell booleans).
- Split `KEEP_CONTAINER` into launcher-specific flags: `KEEP_CONTAINER_DEVCONTAINER`, `KEEP_CONTAINER_CLAUDE`, `KEEP_CONTAINER_EDITOR`.
- Split `CONTAINER_HOSTNAME` into launcher-specific hostnames: `CONTAINER_HOSTNAME_EDITOR`, `CONTAINER_HOSTNAME_DEVCONTAINER`, `CONTAINER_HOSTNAME_CLAUDE` (launchers set `CONTAINER_HOSTNAME` accordingly).
- Moved `DEVCONTAINER_CONTEXT` from Dockerfile into `.env` so the prompt context label is configured from the repo root.
- Fixed in-container env validation for derived `.env` values by passing expanded `CONTAINER_HOSTNAME_*` and `DEVCONTAINER_CONTEXT` via `.devcontainer/devcontainer.json` `containerEnv`.
- Launchers now skip `devcontainer build` when the tagged image already exists (set `FORCE_REBUILD=true` to force a rebuild).
- Added `FORCE_REBUILD=false` to `.env` (opt-in) to control the launcher rebuild behavior.
- Noted in docs that `devcontainer up` can still run a cached "features" build (the `vsc-...` derived image), even when the base image is reused.
- Fixed Claude CLI build-time install to copy `/root/.local/bin/claude` into `/usr/local/bin/claude` so it’s usable by the non-root devcontainer user.

## Next Steps

- Deploy remaining boxes and switch from `/etc/hosts` to Pi-hole DNS (`NAME_RESOLUTION_MODE=dns`, optionally `DNS_PREFLIGHT_CHECK=both`).
- Remove any `/etc/hosts` overrides for `*.hhlab.home.arpa` once DNS is in place (they mask DNS).
- Ensure your local `.env` includes `LOCALE` (example: `en_IE.UTF-8`) so devcontainer builds succeed.
