# 2026-01-11

## Decisions to Implement Next

- FQDN scheme: `service.box.domain` (ADR-0012)
- Name resolution: `/etc/hosts` now, DNS later (`NAME_RESOLUTION_MODE=hosts|dns`) (ADR-0013)
- DNS server/record management out-of-scope for this repo (ADR-0014)
- Traefik is opt-in per service and globally toggleable (ADRs: ADR-0016, `TRAEFIK_ENABLED=true|false`)
- Plan for multiple TLS strategies later (`TRAEFIK_TLS_MODE=mkcert|acme_http|acme_dns`) (ADR-0017)

## Concrete Revamp Checklist

Progress:
- Completed: checklist items 1, 2, 3, 4, 5, 7, 8, 9, 10, 11, and 12 (name-resolution env vars + derived FQDNs + dns preflight + /etc/hosts snippet generation + Traefik dashboard hardening + removed Pi-hole sync from src + CA share UX + CA share gating + shared Traefik middlewares + playbook split).

1. Add name-resolution variables to `.env.example` (completed):
   - `SITE_DOMAIN` is required and must be set in `.env` (no default).
   - `NAME_RESOLUTION_MODE=hosts|dns`
   - `DNS_PREFLIGHT_CHECK=target|controller|both`
2. Refactor host/service naming to derive FQDNs from the scheme (completed):
   - Use `inventory_hostname` (box name) + `SITE_DOMAIN` to build:
     - `whoami_host`, `traefik_dashboard_host`, `ca_share_host`, and future app hosts
   - Keep overrides possible via `host_vars` for edge cases.
   - Add `box_name` host_var to support DNS-safe names when inventory hostnames contain underscores.
3. Add `dns_preflight` role (or pre_tasks) used by all Traefik-exposed services (completed):
   - Always: assert FQDN vars exist and are non-empty.
   - In `NAME_RESOLUTION_MODE=dns`: fail fast if required names do not resolve.
   - DNS resolution check scope is controlled by `DNS_PREFLIGHT_CHECK`:
     - `target` (default): resolve from the target host.
     - `controller`: resolve from the controller (Ansible localhost).
     - `both`: require both to resolve (strictest).
4. Add a deterministic client `/etc/hosts` generator (completed):
   - Script: `scripts/generate-hosts-snippet.sh` (derives `service.<box>.<SITE_DOMAIN>` by default).
   - Playbook behavior: `dns_preflight` prints the snippet automatically in `NAME_RESOLUTION_MODE=hosts`.
   - Optional controller output file: `HOSTS_SNIPPET_OUTPUT_FILE=...`.
5. Traefik hardening follow-up (separate task) (completed):
   - Remove/disable direct dashboard exposure by IP (no `api.insecure: true` in the steady state).
   - Ensure dashboard is reachable only via FQDN and behind an access control mechanism.
6. Documentation updates:
   - Update `documentation/how to use this project.md` with the new variables and bootstrap flow.
   - Update `documentation/how to test.md` to reflect the new resolution modes (hosts vs DNS).
   - Add/maintain `documentation/bootstrap and migration.md` to document hosts → DNS and mkcert → ACME.
7. Remove Pi-hole considerations from `src/` (scope cleanup) (completed):
   - Remove `pihole_sync` from `src/playbooks/pi-apps.yml`.
   - Remove `src/roles/pihole_sync/`.
   - Remove `PIHOLE_*` entries from `.env.example`.
   - Keep Pi-hole notes only as external integration documentation (`documentation/pihole-traefik-instructions.md`).
8. Improve CA share UX (no coupling to `whoami`) (completed):
   - Keep the `ca_share` nginx container, but serve a simple `index.html` landing page.
   - Expose the CA file under a stable filename (`/rootCA.pem`) in addition to any host-specific filename.
9. Gate CA share on name resolution readiness (completed):
   - Do not require DNS specifically; require name resolution (either `/etc/hosts` or DNS) so bootstrap works without a DNS server.
   - In `NAME_RESOLUTION_MODE=dns`, fail fast if `ca_share_host` does not resolve before enabling `CA_SHARE_ENABLED=true`.
10. Traefik hardening (security baseline) (completed):
   - Remove/disable direct dashboard exposure by IP (no `api.insecure: true` in the steady state).
   - Add an access control mechanism for the dashboard (basic auth and/or IP allowlist).
11. Shared Traefik middleware defaults (completed):
   - Provide a standard set of middlewares for admin UIs (security headers, optional auth, optional IP allowlist).
   - Apply consistently to all Traefik-routed admin UIs deployed by this repo.
12. Playbook structure cleanup (completed):
   - Split playbooks into “edge” (Traefik) and “apps” to make order and responsibilities explicit.

## Validation Steps

- Run lint/smoke locally in the devcontainer:
  - `./scripts/ansible-lint.sh src/playbooks/pi-full.yml`
  - `./scripts/ansible-smoke.sh src/playbooks/pi-full.yml src/inventory/hosts.ini`
- Confirm that switching `NAME_RESOLUTION_MODE=hosts` vs `dns` changes only the preflight checks (URLs remain stable).

## Test Plan (Next Run)

1. Baseline: deploy to `rpi-box-03` as a fresh box in a fresh network.
   - Start with `NAME_RESOLUTION_MODE=hosts`.
   - Consider `CA_SHARE_ENABLED=false` on the first deploy, then enable once Traefik + mkcert flow is confirmed.
2. Coexistence: repeat on a box that already runs Pi-hole.
   - Validate port 80/443 conflict behavior (expected early failure if already bound).
   - Switch to `NAME_RESOLUTION_MODE=dns` to validate fail-fast resolution checks once DNS exists.
