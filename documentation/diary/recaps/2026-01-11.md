# 2026-01-11

- Added ADRs to formalize the revamp direction:
  - `service.box.domain` naming scheme with `SITE_DOMAIN` in `.env`.
  - Dual name-resolution modes: `/etc/hosts` now, DNS validation later (`NAME_RESOLUTION_MODE=hosts|dns`).
  - DNS server/record management kept out of this repo.
  - Fail-fast preconditions for FQDN inputs and DNS resolution (when in DNS mode).
- Updated `documentation/README.md` to include the new ADRs.
- Added an ingress decision-matrix ADR to keep Traefik deployment intentional (opt-in).
- Added `TRAEFIK_ENABLED=true|false` (in `.env`) and gated Traefik-related deployment and smoke checks on it.
- Decided to keep a single repo for LAN and VPS targets by introducing a future `TRAEFIK_TLS_MODE` switch (mkcert vs ACME).
- Moved `add-app-via-traefik.md` and `pihole-traefik-instructions.md` under `documentation/` and removed the redundant root copies.
- Implemented name-resolution env vars in `.env.example` (`SITE_DOMAIN`, `NAME_RESOLUTION_MODE`, `DNS_PREFLIGHT_CHECK`).
- Added early `dns_preflight` gating to `src/playbooks/pi-apps.yml` for `NAME_RESOLUTION_MODE=dns` fail-fast checks.
- Implemented derived service FQDNs (`service.<box_name>.<SITE_DOMAIN>`) with an optional `box_name` host_var for DNS-safe naming.
- Added deterministic client `/etc/hosts` snippet generation:
  - Script: `scripts/generate-hosts-snippet.sh`.
  - Automatic playbook output in `NAME_RESOLUTION_MODE=hosts` (optional file output via `HOSTS_SNIPPET_OUTPUT_FILE`).
- Made the Traefik dashboard FQDN/router opt-in via `TRAEFIK_DASHBOARD_ENABLED=true|false`.
- Traefik hardening: removed `api.insecure: true`, bound `TRAEFIK_WEB_PORT` to localhost only, and required dashboard access control (basic auth and/or IP allowlist).
- TLS certs (mkcert): derive SANs per box (`*.box.SITE_DOMAIN` and `box.SITE_DOMAIN`), avoid local cert output collisions, and added `src/playbooks/controller-certs.yml` to pre-generate all box certs on the controller.
- CA share UX: serve `rootCA.pem` at a stable path and render a simple landing page; CA share is gated by name-resolution readiness (hosts snippet or DNS checks).
- Shared Traefik middlewares: standard security headers for admin UIs, with optional shared basic auth and/or IP allowlist applied consistently across services.
- Playbook split: added `src/playbooks/pi-edge.yml` (edge) and `src/playbooks/pi-full.yml` (edge + apps) and made `src/playbooks/pi-apps.yml` apps-only.
- Removed Pi-hole sync from `src/` (deleted `src/roles/pihole_sync/`, removed it from `src/playbooks/pi-apps.yml`, and removed `PIHOLE_*` from `.env.example`); keep Pi-hole as docs-only integration.
- Added a two-phase test plan: baseline on `rpi-box-03` (fresh) followed by coexistence testing with an existing Pi-hole box.
- Devcontainer hardening: require `LOCALE` as a build arg, install `git-filter-repo`, and enforce strict pinned installs for `ansible-core`, `ansible-lint`, and `yamllint`.
- Devcontainer UX: added a custom image `ENTRYPOINT` and global prompt sourcing so interactive/login shells consistently load `.devcontainer/scripts/bash-prompt.sh`.
- Devcontainer tooling: added the VS Code extension `anthropic.claude-code` to `.devcontainer/devcontainer.json`.
- Devcontainer SSH: mount host `SSH_AUTH_SOCK` at `/ssh-agent` and set `SSH_AUTH_SOCK=/ssh-agent` per ADR-0005.
- Devcontainer workspace: made the container workspace path configurable via `WORKSPACE_FOLDER` (devcontainer mount/folder and helper scripts no longer assume `/workspace`).
- Devcontainer prompt: Starship now shows `PROJECT_NAME` via an `env_var` module (removed `username`/`hostname`).
- Devcontainer prompt: hardened `.devcontainer/scripts/bash-prompt.sh` to tolerate `set -u` and to force Starship to use the repo `starship.toml`.
- Env loader: fail-fast if `.env` is missing, preserves forwarded `SSH_AUTH_SOCK`, avoids `mktemp`, and only prints values when `ENV_LOADER_DEBUG_VALUES=true`.
- Devcontainer verification: `verify-git-ssh.sh` now accepts `GIT_SSH_HOST` fallback and uses boolean `PASS=true/false` with `echo` for spacing.
- Devcontainer env validation: `validate-env.sh` now validates `PROJECT_NAME`, `WORKSPACE_FOLDER`, Ansible path vars, pinned tooling versions, and checks forwarded `SSH_AUTH_SOCK` is a socket.
- Devcontainer SSH agent setup: `ssh-agent-setup.sh` is now idempotent per shell, preserves/restores shell options, and can reuse a saved local agent from `~/.ssh/agent_env` when forwarding is unavailable.
- Devcontainer init: `init-devcontainer.sh` now uses boolean `loader_found` and respects `WORKSPACE_FOLDER` for the repo git identity setup.
- Devcontainer post-create: now runs `validate-env.sh` and prepends a `.bashrc` guard for `VSCODE_SHELL_LOGIN` to avoid nounset issues.
- Devcontainer Claude CLI: added optional build-time install controlled by `INSTALL_CLAUDE` (and optional `CLAUDE_INSTALL_SHA256`) passed as build args.
- Removed emoji/symbol characters from `documentation/diary/references/` documents to match repo policy (text-only).
- Reduced "magic defaults" outside `src/`: removed hidden fallbacks (e.g. `EDITOR_CHOICE`), documented host helper defaults in `.env.example`, and made build-time Claude install/prompt sourcing fail fast when required args/env are missing.
- Refactored devcontainer helper scripts to validate required env up front (and derive `workspace_dir` from script location), avoiding scattered `${VAR:?}` checks.
- Centralized host-side env validation in `scripts/validate-env.sh`; launchers call it, and in-container scripts now assume env is already present (fail with a "use the launcher" hint when it isn't).
- Removed `.devcontainer/config/.env*`; the project-root `.env` is now the only supported configuration source for devcontainer runs.
- Fixed `validate-env.sh` regex patterns (escape handling) so `LOCALE` and pinned version checks validate correctly.
- Claude launcher: `./claude-launch.sh` now forces `INSTALL_CLAUDE=true` so the container image always includes the `claude` CLI for that workflow.
- Starship prompt: removed `CONTAINER_HOSTNAME` from the prompt to avoid noisy session-specific hostnames, and switched to a compact first line.
- Image naming: `.env` keeps the editor-based `DOCKER_IMAGE_NAME=${PROJECT_NAME}-${EDITOR_CHOICE}`, while `./devcontainer-launch.sh` forces `${PROJECT_NAME}-devcontainer` and `./claude-launch.sh` forces `${PROJECT_NAME}-claude`.
- Standardized boolean flags to `true|false` (removed remaining `...=1` style toggles and docs, and scripts treat them as shell booleans).
- Split `KEEP_CONTAINER` into launcher-specific flags: `KEEP_CONTAINER_DEVCONTAINER`, `KEEP_CONTAINER_CLAUDE`, `KEEP_CONTAINER_EDITOR`.
- Split `CONTAINER_HOSTNAME` into launcher-specific hostnames: `CONTAINER_HOSTNAME_EDITOR`, `CONTAINER_HOSTNAME_DEVCONTAINER`, `CONTAINER_HOSTNAME_CLAUDE` (launchers set `CONTAINER_HOSTNAME` accordingly).
- Moved `DEVCONTAINER_CONTEXT` from Dockerfile into `.env` so the prompt context label is configured from the repo root.
- Fixed in-container env validation for derived `.env` values by passing expanded `CONTAINER_HOSTNAME_*` and `DEVCONTAINER_CONTEXT` via `.devcontainer/devcontainer.json` `containerEnv`.
- Launchers now skip `devcontainer build` when the tagged image already exists (set `FORCE_REBUILD=true` to force a rebuild).
- Added `FORCE_REBUILD=false` to `.env` (opt-in) to control the launcher rebuild behavior.
- Noted in docs that `devcontainer up` can still run a cached "features" build (the `vsc-...` derived image), even when the base image is reused.
- Fixed Claude CLI build-time install to copy `/root/.local/bin/claude` into `/usr/local/bin/claude` so itâ€™s usable by the non-root devcontainer user.
